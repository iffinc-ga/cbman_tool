<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Customer Invoice Tool</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Lucide Icons
        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );
        const Copy = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        );
        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );
        const Trash = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );
        const AlertCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const CheckCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const Loader = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        // Customer configurations (unchanged)
        const CUSTOMERS = {
            grass: { name: 'Grass', color: 'green', dbFileName: 'updated_grass_db.xlsx', tariffColumns: ['TARIFF NUM', 'TARIFF NUM_1', 'TARIFF NUM_2', 'TARIFF NUM_3', 'TARIFF NUM_4'], tariffFilter: (t) => !t.startsWith('9'), partNumColumn: 'PRIMARY PART NUM' },
            vieler: { name: 'Vieler', color: 'blue', dbFileName: 'vieler_db.xlsx', tariffColumns: ['TARIFF NUM', 'TARIFF NUM_1', 'TARIFF NUM_2', 'TARIFF NUM_3', 'TARIFF NUM_4'], tariffFilter: (t) => !t.startsWith('9'), partNumColumn: 'PRIMARY PART NUM' },
            cb: { name: 'CB Manufacturing', color: 'purple', dbFileName: 'updated_cbman_db.xlsx', tariffColumns: ['TARIFF NUM', 'TARIFF NUM_2', 'TARIFF NUM_3', 'TARIFF NUM_4', 'TARIFF NUM_5'], tariffFilter: (t) => !t.startsWith('9'), partNumColumn: 'PRIMARY PART NUM' },
            manki: { name: 'Manki', color: 'orange', dbFileName: 'updated_manki_db.xlsx', tariffColumns: ['TARIFF NUM', 'TARIFF NUM_1', 'TARIFF NUM_2','TARIFF NUM_3','TARIFF NUM_4', 'TARIFF NUM_5'], tariffFilter: (t) => t.startsWith('3'), partNumColumn: 'PRIMARY PART NUM' },
            eisenmann: { name: 'Eisenmann', color: 'indigo', dbFileName: 'updated_eisenmann_db.xlsx', tariffColumns: ['TARIFF NUM', 'TARIFF NUM_1', 'TARIFF NUM_2', 'TARIFF NUM_3', 'TARIFF NUM_4'], tariffFilter: (t) => !t.startsWith('9'), partNumColumn: 'PRIMARY PART NUM' }
        };

        const isBaseTariff = (tariff) => {
            const t = String(tariff || '').trim();
            if (!t) return false;
            const two = parseInt(t.substring(0, 2));
            const one = parseInt(t.substring(0, 1));
            return (!isNaN(two) && two >= 10 && two <= 97) || (!isNaN(one) && one >= 1 && one <= 9);
        };

        function MultiCustomerTool() {
            const [selectedCustomer, setSelectedCustomer] = useState('grass');
            const [invoiceData, setInvoiceData] = useState([]);
            const [customerDbData, setCustomerDbData] = useState([]);
            const [tariffMappings, setTariffMappings] = useState([]);
            const [selectedRow, setSelectedRow] = useState(null);
            const [message, setMessage] = useState(null);
            const [fileName, setFileName] = useState('');
            const [dbLoaded, setDbLoaded] = useState(false);
            const [dbLoading, setDbLoading] = useState(false);
            const [quantity, setQuantity] = useState('');
            const [unitPrice, setUnitPrice] = useState('');
            const [itemTotal, setItemTotal] = useState('');
            const [duplicateCount, setDuplicateCount] = useState(0);
            const [lastSelectedRow, setLastSelectedRow] = useState(null);
            const fileInputRef = useRef(null);

            const currentCustomer = CUSTOMERS[selectedCustomer];

            useEffect(() => { loadCustomerDb(); }, [selectedCustomer]);

            const loadCustomerDb = async () => {
                setDbLoading(true);
                setDbLoaded(false);
                setInvoiceData([]);
                try {
                    const response = await fetch(currentCustomer.dbFileName);
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer);
                    const mainSheet = workbook.Sheets[workbook.SheetNames[0]];
                    setCustomerDbData(XLSX.utils.sheet_to_json(mainSheet, { defval: "" }));
                    if (workbook.SheetNames.includes('Sheet1')) {
                        const mappings = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet1'], { header: 1, defval: "" });
                        setTariffMappings(mappings.slice(1));
                    }
                    setDbLoaded(true);
                    setMessage({ type: 'success', text: `${currentCustomer.name} DB loaded` });
                } catch (e) {
                    setMessage({ type: 'error', text: e.message });
                } finally {
                    setDbLoading(false);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setFileName(file.name);
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const workbook = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws, { defval: "" });
                    setInvoiceData(data);
                    setMessage({ type: 'success', text: `${data.length} rows loaded` });
                };
                reader.readAsArrayBuffer(file);
            };

            const findTariffValue = (partNumber, materialType, mode = 'content') => {
                const p = String(partNumber || '').trim();
                const cfg = currentCustomer;
                const part = customerDbData.find(r => String(r[cfg.partNumColumn] || '').trim() === p);
                if (!part) return { found: true, value: materialType === 'aluminum' ? 'ALL ALUM GENERIC' : 'ALL STEEL GENERIC', materialType, partNotFound: true, mode };
                if (mode === 'all') {
                    let baseTariff = null;
                    for (const c of cfg.tariffColumns) {
                        const t = String(part[c] || '').trim();
                        if (t && isBaseTariff(t)) { baseTariff = t; break; }
                    }
                    if (!baseTariff)
                        return { found: true, value: materialType === 'aluminum' ? 'ALL ALUM GENERIC' : 'ALL STEEL GENERIC', noBaseTariff: true, mode };
                    const mapping = tariffMappings.find(r => String(r[0] || '').trim() === baseTariff);
                    const colIdx = materialType === 'aluminum' ? 3 : 4;
                    if (mapping && mapping[colIdx])
                        return { found: true, value: mapping[colIdx], tariff: baseTariff, mode };
                    return { found: true, value: materialType === 'aluminum' ? 'ALL ALUM GENERIC' : 'ALL STEEL GENERIC', usingDefault: true, tariff: baseTariff, mode };
                }
                let tariffNumber = null;
                for (const c of cfg.tariffColumns) {
                    const t = String(part[c] || '').trim();
                    if (t && cfg.tariffFilter(t)) { tariffNumber = t; break; }
                }
                if (!tariffNumber)
                    return { found: true, value: materialType === 'aluminum' ? 'ALUM EXCL GENERIC' : 'STEEL EXCL GENERIC', noValidTariff: true, mode };
                const mapping = tariffMappings.find(r => String(r[0] || '').trim() === tariffNumber);
                const colIdx = materialType === 'aluminum' ? 1 : 2;
                if (mapping && mapping[colIdx])
                    return { found: true, value: mapping[colIdx], tariff: tariffNumber, mode };
                return { found: true, value: materialType === 'aluminum' ? 'ALUM EXCL GENERIC' : 'STEEL EXCL GENERIC', usingDefault: true, tariff: tariffNumber, mode };
            };

            // ---- AMENDED FUNCTION ----
            const duplicateRow = (materialType, mode = 'content') => {
                if (selectedRow === null) return setMessage({ type: 'error', text: 'Select a row first' });
                const rowToDuplicate = invoiceData[selectedRow];
                const partNumber = rowToDuplicate.BuyerPartNumber;
                const tariffResult = findTariffValue(partNumber, materialType, mode);

                if (mode === 'all') {
                    // Replace the original row instead of duplicating
                    const updatedRow = { ...rowToDuplicate };
                    updatedRow.BuyerPartNumber = tariffResult.value;
                    updatedRow.SupplierPartNumber = tariffResult.value;
                    const newData = [...invoiceData];
                    newData[selectedRow] = updatedRow;
                    setInvoiceData(newData);
                    const matLabel = materialType === 'aluminum' ? 'All Aluminum' : 'All Steel';
                    setMessage({ type: 'success', text: `Replaced Supplier Part # with ${matLabel}: ${tariffResult.value}` });
                    return;
                }

                // Keep original duplication logic for "content"
                const newRow = { ...rowToDuplicate };
                newRow.BuyerPartNumber = tariffResult.value;
                newRow.SupplierPartNumber = tariffResult.value;
                newRow._isDuplicate = true;
                const insertPos = selectedRow + 1;
                const newData = [
                    ...invoiceData.slice(0, insertPos),
                    newRow,
                    ...invoiceData.slice(insertPos)
                ];
                setInvoiceData(newData);
                const matLabel = materialType === 'aluminum' ? 'Aluminum Content' : 'Steel Content';
                setMessage({ type: 'success', text: `Added ${matLabel} duplicate: ${tariffResult.value}` });
            };
            // ---------------------------

            const downloadFile = () => {
                if (!invoiceData.length) return setMessage({ type: 'error', text: 'No data to download' });
                const ws = XLSX.utils.json_to_sheet(invoiceData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                const newName = fileName.replace('.xlsx', `_${selectedCustomer}_updated.xlsx`);
                XLSX.writeFile(wb, newName);
                setMessage({ type: 'success', text: `File downloaded: ${newName}` });
            };

            const getColorClasses = (t) => {
                const c = { green: 'green', blue: 'blue', purple: 'purple', orange: 'orange', indigo: 'indigo' }[currentCustomer.color];
                const map = {
                    bg: `bg-${c}-600`,
                    hover: `hover:bg-${c}-700`,
                    light: `bg-${c}-50`,
                    text: `text-${c}-600`
                };
                return map[t];
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4">
                    <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-4">
                        <h1 className="text-xl font-bold mb-3">Multi-Customer Invoice Tool</h1>

                        <div className="flex gap-2 mb-4">
                            {Object.entries(CUSTOMERS).map(([k, c]) => (
                                <button key={k} onClick={() => setSelectedCustomer(k)}
                                    className={`px-4 py-2 rounded-lg text-sm font-semibold ${selectedCustomer === k ? `bg-${c.color}-600 text-white` : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                    {c.name}
                                </button>
                            ))}
                        </div>

                        {message && (
                            <div className={`p-3 mb-3 rounded border ${message.type === 'success' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700'}`}>
                                {message.text}
                            </div>
                        )}

                        <div className="flex gap-2 mb-3 flex-wrap">
                            <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".xlsx,.xls" className="hidden" />
                            <button onClick={() => fileInputRef.current?.click()} disabled={!dbLoaded}
                                className={`flex items-center gap-2 px-4 py-2 text-sm ${getColorClasses('bg')} text-white rounded-lg ${getColorClasses('hover')}`}>
                                <Upload className="w-4 h-4" /> Upload Invoice
                            </button>

                            <button onClick={() => duplicateRow('aluminum', 'all')} disabled={selectedRow === null}
                                className="flex items-center gap-2 px-4 py-2 text-sm bg-sky-600 text-white rounded-lg hover:bg-sky-700">
                                <Copy className="w-4 h-4" /> All Aluminum
                            </button>

                            <button onClick={() => duplicateRow('steel', 'all')} disabled={selectedRow === null}
                                className="flex items-center gap-2 px-4 py-2 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-800">
                                <Copy className="w-4 h-4" /> All Steel
                            </button>

                            <button onClick={() => duplicateRow('aluminum', 'content')} disabled={selectedRow === null}
                                className="flex items-center gap-2 px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <Copy className="w-4 h-4" /> Aluminum Content
                            </button>

                            <button onClick={() => duplicateRow('steel', 'content')} disabled={selectedRow === null}
                                className="flex items-center gap-2 px-4 py-2 text-sm bg-slate-600 text-white rounded-lg hover:bg-slate-700">
                                <Copy className="w-4 h-4" /> Steel Content
                            </button>

                            <button onClick={downloadFile} disabled={!invoiceData.length}
                                className="flex items-center gap-2 px-4 py-2 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                <Download className="w-4 h-4" /> Download
                            </button>
                        </div>

                        {invoiceData.length > 0 && (
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm border">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th className="px-3 py-2 border">#</th>
                                            <th className="px-3 py-2 border">Invoice #</th>
                                            <th className="px-3 py-2 border">Supplier Part #</th>
                                            <th className="px-3 py-2 border">Description</th>
                                            <th className="px-3 py-2 border">Quantity</th>
                                            <th className="px-3 py-2 border">Unit Price</th>
                                            <th className="px-3 py-2 border">Item Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {invoiceData.map((row, i) => (
                                            <tr key={i} onClick={() => setSelectedRow(i)}
                                                className={`${selectedRow === i ? 'bg-green-50' : ''} cursor-pointer`}>
                                                <td className="px-3 py-2 border">{i + 1}</td>
                                                <td className="px-3 py-2 border">{row.InvoiceNumber}</td>
                                                <td className="px-3 py-2 border">{row.SupplierPartNumber}</td>
                                                <td className="px-3 py-2 border">{row.Description}</td>
                                                <td className="px-3 py-2 border text-right">{row.Quantity}</td>
                                                <td className="px-3 py-2 border text-right">{row.UnitPrice}</td>
                                                <td className="px-3 py-2 border text-right">{row.ItemTotal}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MultiCustomerTool />);
    </script>
</body>
</html>
