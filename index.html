<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multi-Customer Invoice Tool (Debug Enabled)</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* ---------------- Icons ---------------- */
const Upload = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>);
const Copy = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>);
const Download = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>);
const AlertCircle = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>);
const CheckCircle = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>);

/* ---------------- Customer Config ---------------- */
const CUSTOMERS = {
  grass: {
    name: 'Grass', color: 'green', dbFileName: 'updated_grass_db.xlsx',
    tariffColumns: ['TARIFF NUM', 'TARIFF NUM_1','TARIFF NUM_2','TARIFF NUM_3','TARIFF NUM_4'],
    partNumColumn: 'PRIMARY PART NUM'
  },
  vieler: {
    name: 'Vieler', color: 'blue', dbFileName: 'vieler_db.xlsx',
    tariffColumns: ['TARIFF NUM', 'TARIFF NUM_1','TARIFF NUM_2','TARIFF NUM_3','TARIFF NUM_4'],
    partNumColumn: 'PRIMARY PART NUM'
  }
};

/* ---------------- Utility ---------------- */
const normalizeTariff = (t) => {
  if (!t) return '';
  const digits = String(t).replace(/\D/g, '');
  return digits.replace(/^0+/, '') || digits;
};

/* ---------------- Component ---------------- */
function MultiCustomerTool() {
  const [selectedCustomer, setSelectedCustomer] = useState('grass');
  const [invoiceData, setInvoiceData] = useState([]);
  const [dbData, setDbData] = useState([]);
  const [tariffMap, setTariffMap] = useState([]);
  const [selectedRow, setSelectedRow] = useState(null);
  const [msg, setMsg] = useState(null);
  const fileRef = useRef();
  const customer = CUSTOMERS[selectedCustomer];

  useEffect(() => { loadDb(); }, [selectedCustomer]);

  const loadDb = async () => {
    setMsg({ type: 'info', text: `Loading ${customer.name} DB...` });
    try {
      const res = await fetch(customer.dbFileName);
      if (!res.ok) throw new Error('File not found');
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf);
      const main = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
      setDbData(main);
      if (wb.SheetNames.includes('Sheet1')) {
        const sheet1 = XLSX.utils.sheet_to_json(wb.Sheets['Sheet1'], { header: 1, defval: '' });
        setTariffMap(sheet1.slice(1));
      }
      setMsg({ type: 'success', text: `${customer.name} DB loaded (${main.length} rows)` });
    } catch (e) {
      setMsg({ type: 'error', text: e.message });
    }
  };

  const handleFile = (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      const wb = XLSX.read(ev.target.result, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      setInvoiceData(XLSX.utils.sheet_to_json(ws, { defval: '' }));
      setMsg({ type: 'success', text: `Loaded ${f.name}` });
    };
    r.readAsArrayBuffer(f);
  };

  // --- Main find logic ---
  const findTariffValue = (part, material, mode='content') => {
    const record = dbData.find(r => String(r[customer.partNumColumn]||'').trim()===String(part||'').trim());
    if (!record) return { value: material==='aluminum'?'ALL ALUM GENERIC':'ALL STEEL GENERIC', note:'Part not found' };

    const tariffs = customer.tariffColumns.map(c=>String(record[c]||'').trim()).filter(Boolean);
    const normalized = tariffs.map(normalizeTariff);
    let matchRow=null, matchTariff=null;
    for (const t of normalized){
      const row = tariffMap.find(r=>normalizeTariff(r[0])===t);
      if (row){matchRow=row; matchTariff=t; break;}
    }

    if (!matchRow){
      return { value: material==='aluminum'?'ALL ALUM GENERIC':'ALL STEEL GENERIC', tariffs, normalized, note:'No match found' };
    }

    const col = mode==='all' ? (material==='aluminum'?3:4) : (material==='aluminum'?1:2);
    const val = matchRow[col] || (material==='aluminum'?'ALL ALUM GENERIC':'ALL STEEL GENERIC');
    return { value: val.trim(), tariffs, normalized, matchTariff, note:'Matched' };
  };

  // --- Debug button ---
  const debugTariff = () => {
    if (selectedRow===null){ alert('Select a row first.'); return; }
    const row = invoiceData[selectedRow];
    const part = row.BuyerPartNumber;
    const steel = findTariffValue(part,'steel','all');
    const alum = findTariffValue(part,'aluminum','all');
    const report = `
Part: ${part}
Tariffs found in DB: ${steel.tariffs ? steel.tariffs.join(', ') : 'N/A'}
Normalized: ${steel.normalized ? steel.normalized.join(', ') : 'N/A'}

Steel result: ${steel.value}
Note: ${steel.note}
Matched tariff: ${steel.matchTariff || 'None'}

Aluminum result: ${alum.value}
Note: ${alum.note}
Matched tariff: ${alum.matchTariff || 'None'}
    `;
    console.log(report);
    alert(report);
    setMsg({ type:'info', text:`Debug info shown for ${part}. Check console for details.` });
  };

  const duplicateRow = (mat, mode='all')=>{
    if(selectedRow===null){setMsg({type:'error',text:'Select a row'});return;}
    const row = invoiceData[selectedRow];
    const res = findTariffValue(row.BuyerPartNumber,mat,mode);
    const newRow = {...row, BuyerPartNumber:res.value, SupplierPartNumber:res.value};
    const data=[...invoiceData];
    data[selectedRow]=newRow;
    setInvoiceData(data);
    setMsg({type:'success',text:`Replaced with ${res.value}`});
  };

  return (
    <div className="p-4 max-w-6xl mx-auto">
      <h1 className="text-xl font-bold mb-3">Multi-Customer Invoice Tool (Debug Enabled)</h1>
      <div className="flex gap-2 mb-3">
        {Object.entries(CUSTOMERS).map(([k,c])=>
          <button key={k} onClick={()=>setSelectedCustomer(k)}
            className={`px-3 py-2 rounded ${selectedCustomer===k?`bg-${c.color}-600 text-white`:'bg-gray-100'}`}>{c.name}</button>)}
      </div>

      {msg && <div className={`mb-3 p-2 rounded ${msg.type==='success'?'bg-green-50':msg.type==='error'?'bg-red-50':'bg-blue-50'}`}>{msg.text}</div>}

      <div className="flex gap-2 mb-3">
        <input type="file" ref={fileRef} onChange={handleFile} accept=".xlsx" className="hidden"/>
        <button onClick={()=>fileRef.current?.click()} className="px-3 py-2 bg-green-600 text-white rounded flex items-center gap-1"><Upload className="w-4 h-4"/> Upload</button>
        <button onClick={()=>duplicateRow('steel','all')} disabled={selectedRow===null} className="px-3 py-2 bg-gray-700 text-white rounded flex items-center gap-1"><Copy className="w-4 h-4"/> All Steel</button>
        <button onClick={()=>duplicateRow('aluminum','all')} disabled={selectedRow===null} className="px-3 py-2 bg-sky-600 text-white rounded flex items-center gap-1"><Copy className="w-4 h-4"/> All Aluminum</button>
        <button onClick={debugTariff} disabled={selectedRow===null} className="px-3 py-2 bg-yellow-500 text-white rounded flex items-center gap-1">ðŸ§© Debug Tariff Match</button>
      </div>

      {invoiceData.length>0 && (
        <table className="w-full border text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="border px-2 py-1">#</th>
              <th className="border px-2 py-1">Invoice #</th>
              <th className="border px-2 py-1">Supplier Part #</th>
              <th className="border px-2 py-1">Description</th>
            </tr>
          </thead>
          <tbody>
            {invoiceData.map((r,i)=>(
              <tr key={i} onClick={()=>setSelectedRow(i)} className={`${selectedRow===i?'bg-green-50':'cursor-pointer hover:bg-gray-50'}`}>
                <td className="border px-2">{i+1}</td>
                <td className="border px-2">{r.InvoiceNumber}</td>
                <td className="border px-2">{r.SupplierPartNumber}</td>
                <td className="border px-2">{r.Description}</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
}

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<MultiCustomerTool/>);
</script>
</body>
</html>
